<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3000World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
        }
        .chat-bubble { max-width: 80%; width: fit-content; }
        .chat-bubble-user { background-color: #3b82f6; color: white; align-self: flex-end; }
        .chat-bubble-char { background-color: #4b5563; color: white; align-self: flex-start; }
        .speaker-name { font-size: 0.8rem; font-weight: bold; color: #d1d5db; margin-bottom: 4px; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #374151; }
        #group-char-selection label { display: block; margin-bottom: 0.5rem; }
    </style>
</head>
<body class="bg-gray-900 text-white overflow-hidden">

    <!-- World Selection Dialog -->
    <div id="world-selector-dialog" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md relative">
            <div class="absolute top-4 right-4">
                <button id="lang-switcher" class="text-sm text-gray-400 hover:text-white" data-i18n="langSwitcherLabel">语言: 简体中文</button>
            </div>
            <h2 class="text-3xl font-bold text-center mb-6" data-i18n="appTitle">3000World</h2>
            <div id="existing-worlds-container">
                <h3 class="text-lg font-semibold mb-3" data-i18n="selectWorldTitle">选择一个世界</h3>
                <div class="flex space-x-3 mb-6">
                    <select id="world-select-dropdown" class="flex-grow bg-gray-700 p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                    <button id="enter-world-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg" data-i18n="enterWorldBtn">进入</button>
                </div>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-3" data-i18n="createWorldTitle">或者, 创建一个新世界</h3>
                <div class="flex space-x-3">
                    <input type="text" id="new-world-name" data-i18n-placeholder="newWorldPlaceholder" placeholder="输入新世界的名称..." class="flex-grow bg-gray-700 p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button id="create-world-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-5 rounded-lg" data-i18n="createWorldBtn">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application UI (Initially Hidden) -->
    <div id="main-app" class="hidden flex h-screen">
        <!-- Left Sidebar -->
        <aside class="w-1/4 bg-gray-800 p-4 flex flex-col custom-scrollbar overflow-y-auto">
            <div class="mb-6">
                <h2 class="text-xl font-bold mb-3" data-i18n="groupChatTitle">群聊</h2>
                <button id="new-group-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg mb-3" data-i18n="newGroupBtn">创建新群组</button>
                <ul id="group-list" class="space-y-2"></ul>
            </div>
            <div class="mb-6">
                <h2 class="text-xl font-bold mb-3" data-i18n="characterCardTitle">角色卡片</h2>
                <button id="new-char-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mb-3" data-i18n="newCharBtn">创建新角色</button>
                <ul id="char-list" class="space-y-2"></ul>
            </div>
            <div>
                <h2 class="text-xl font-bold mb-3" data-i18n="worldBookTitle">世界设定集</h2>
                <button id="new-world-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mb-3" data-i18n="newWorldEntryBtn">创建新条目</button>
                <ul id="world-list" class="space-y-2"></ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="w-1/2 bg-gray-900 flex flex-col p-4 h-screen">
            <div id="chat-welcome" class="flex flex-col items-center justify-center h-full text-center">
                <h1 class="text-3xl font-bold text-gray-400" data-i18n="welcomeTitle">欢迎使用</h1>
                <p class="text-gray-500 mt-2" data-i18n="welcomeMessage">从左侧选择一个群组或角色开始对话。</p>
            </div>
            <div id="chat-area" class="hidden flex-1 flex flex-col min-h-0">
                 <div id="chat-header" class="border-b-2 border-gray-700 pb-2 mb-4 flex-shrink-0">
                    <h2 id="chat-session-name" class="text-2xl font-bold"></h2>
                    <p id="chat-participants" class="text-sm text-gray-400"></p>
                </div>
                <div id="chat-history-container" class="flex-1 custom-scrollbar overflow-y-auto pr-4">
                    <div id="chat-history" class="space-y-4 flex flex-col"></div>
                </div>
                <div class="mt-4 relative flex-shrink-0">
                    <div id="mention-suggestions" class="hidden absolute bottom-full mb-2 w-full bg-gray-700 border border-gray-600 rounded-lg shadow-lg z-10 max-h-48 overflow-y-auto custom-scrollbar"></div>
                    <div class="flex items-center">
                        <textarea id="user-input" class="w-full p-3 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" data-i18n-placeholder="userInputPlaceholder" placeholder="输入你的消息, 可使用 @ 来提及角色..." rows="2"></textarea>
                        <button id="send-btn" class="ml-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg" data-i18n="sendBtn">发送</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="w-1/4 bg-gray-800 p-6 custom-scrollbar overflow-y-auto">
            <div id="editor-panel">
                <div id="editor-welcome" class="text-gray-500">
                    <h3 class="text-xl font-bold mb-2" data-i18n="editorTitle">编辑器</h3>
                    <p data-i18n="editorWelcomeMessage">点击 "创建" 或选择现有条目进行编辑。</p>
                </div>
                <form id="group-editor" class="hidden space-y-4"></form>
                <form id="char-editor" class="hidden space-y-4"></form>
                <form id="world-editor" class="hidden space-y-4"></form>
            </div>
        </aside>
    </div>

    <script>
    $(async function() { // Document Ready
    
    // --- I18N SETUP ---
    const i18n = {
        'zh-CN': {
            langSwitcherLabel: '语言: 简体中文', appTitle: '3000World',
            selectWorldTitle: '选择一个世界', enterWorldBtn: '进入',
            createWorldTitle: '或者, 创建一个新世界', newWorldPlaceholder: '输入新世界的名称...', createWorldBtn: '创建',
            groupChatTitle: '群聊', newGroupBtn: '创建新群组',
            characterCardTitle: '角色卡片', newCharBtn: '创建新角色',
            worldBookTitle: '世界设定集', newWorldEntryBtn: '创建新条目',
            welcomeTitle: '欢迎使用', welcomeMessage: '从左侧选择一个群组或角色开始对话。',
            userInputPlaceholder: '输入你的消息, 可使用 @ 来提及角色...', sendBtn: '发送',
            editorTitle: '编辑器', editorWelcomeMessage: '点击 "创建" 或选择现有条目进行编辑。'
        },
        'en-US': {
            langSwitcherLabel: 'Language: English', appTitle: '3000World',
            selectWorldTitle: 'Select a World', enterWorldBtn: 'Enter',
            createWorldTitle: 'Or, Create a New World', newWorldPlaceholder: 'Enter new world name...', createWorldBtn: 'Create',
            groupChatTitle: 'Group Chats', newGroupBtn: 'New Group',
            characterCardTitle: 'Characters', newCharBtn: 'New Character',
            worldBookTitle: 'Worldbook', newWorldEntryBtn: 'New Entry',
            welcomeTitle: 'Welcome', welcomeMessage: 'Select a group or character from the left to start chatting.',
            userInputPlaceholder: 'Type your message, use @ to mention characters...', sendBtn: 'Send',
            editorTitle: 'Editor', editorWelcomeMessage: 'Click "Create" or select an existing item to edit.'
        }
    };

    let currentLang = 'zh-CN';

    function setLanguage(lang) {
        if (!i18n[lang]) lang = 'zh-CN'; // Fallback
        currentLang = lang;
        localStorage.setItem('3000world-lang', lang);
        
        const strings = i18n[lang];
        $('[data-i18n]').each(function() {
            const key = $(this).data('i18n');
            if (strings[key]) $(this).text(strings[key]);
        });
        $('[data-i18n-placeholder]').each(function() {
            const key = $(this).data('i18n-placeholder');
            if (strings[key]) $(this).attr('placeholder', strings[key]);
        });
    }

    function getLanguage() {
        return localStorage.getItem('3000world-lang') || 'zh-CN';
    }

    // --- GLOBAL APP STATE ---
    const DB_PREFIX = '3000World_';
    const DB_VERSION = 2;
    let db; // This will hold the connection to the selected world's database

    let currentState = {
        sessionId: null,
        sessionType: null,
        characterCache: new Map(),
    };

    // --- STARTUP LOGIC: WORLD SELECTION ---
    async function showWorldSelectionDialog() {
        if (!window.indexedDB.databases) {
            $('#existing-worlds-container').html('<p class="text-yellow-400 text-sm">您的浏览器不支持数据库列表，请直接创建新世界。</p>');
            return;
        }

        const databases = await window.indexedDB.databases();
        const worldDbs = databases.filter(db => db.name.startsWith(DB_PREFIX));
        const $dropdown = $('#world-select-dropdown').empty();

        if (worldDbs.length === 0) {
            $('#existing-worlds-container').hide();
        } else {
            $('#existing-worlds-container').show();
            $dropdown.append($('<option>').text('请选择...').val(''));
            worldDbs.forEach(dbInfo => {
                const worldName = dbInfo.name.replace(DB_PREFIX, '');
                const $option = $('<option></option>').text(worldName).val(worldName);
                $dropdown.append($option);
            });
        }
    }
    
    async function enterWorld(worldName) {
        if (!worldName) {
            alert('世界名称不能为空！');
            return;
        }

        const dbName = `${DB_PREFIX}${worldName}`;
        try {
            db = await initDB(dbName);
            $('#world-selector-dialog').fadeOut(300);
            $('#main-app').removeClass('hidden');
            initializeAppLogic(); // Initialize the rest of the app
        } catch (error) {
            alert(`进入世界失败: ${error}`);
        }
    }

    $('#create-world-btn').on('click', () => {
        const newWorldName = $('#new-world-name').val().trim();
        enterWorld(newWorldName);
    });

    $('#enter-world-btn').on('click', () => {
        const selectedWorld = $('#world-select-dropdown').val();
        if (selectedWorld) {
            enterWorld(selectedWorld);
        } else {
            alert('请从下拉列表中选择一个世界。');
        }
    });

    $('#new-world-name').on('keydown', (e) => {
        if (e.key === 'Enter') {
            const newWorldName = $('#new-world-name').val().trim();
            enterWorld(newWorldName);
        }
    });
    
    $('#lang-switcher').on('click', () => {
        const newLang = currentLang === 'zh-CN' ? 'en-US' : 'zh-CN';
        setLanguage(newLang);
    });

    // --- DATABASE (IndexedDB) SETUP ---
    function initDB(dbName) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, DB_VERSION);
            request.onerror = e => reject(`Database error: ${e.target.error}`);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('characters')) db.createObjectStore('characters', { keyPath: 'id', autoIncrement: true });
                if (!db.objectStoreNames.contains('worldbooks')) db.createObjectStore('worldbooks', { keyPath: 'id', autoIncrement: true });
                if (!db.objectStoreNames.contains('groups')) db.createObjectStore('groups', { keyPath: 'id', autoIncrement: true });
                if (db.objectStoreNames.contains('chat_history')) db.deleteObjectStore('chat_history');
                const chatStore = db.createObjectStore('chat_history', { keyPath: 'id', autoIncrement: true });
                chatStore.createIndex('sessionId', 'sessionId', { unique: false });
            };
            request.onsuccess = e => {
                console.log(`Successfully connected to world: ${dbName}`);
                resolve(e.target.result);
            };
        });
    }

    // --- UTILITY & CORE FUNCTIONS ---
    function getStore(storeName, mode) {
        return db.transaction(storeName, mode).objectStore(storeName);
    }
    
    function showEditor(type) {
        $('#editor-welcome, #char-editor, #world-editor, #group-editor').hide();
        if (type) $(`#${type}-editor`).show();
        else { $('#editor-welcome').show(); clearForms(); }
    }

    function clearForms() {
        $('#char-editor, #world-editor, #group-editor').each(function() { this.reset(); });
        $('#char-id, #world-id, #group-id').val('');
        const buttons = { 'delete-char-btn': '删除角色', 'delete-group-btn': '删除群组', 'delete-world-btn': '删除条目' };
        for (const [btnId, text] of Object.entries(buttons)) {
            $(`#${btnId}`).hide().removeAttr('data-confirming').text(text)
                .removeClass('bg-yellow-500 hover:bg-yellow-600').addClass('bg-red-600 hover:bg-red-700');
        }
    }

    async function cacheAllCharacters() {
        currentState.characterCache.clear();
        const store = getStore('characters', 'readonly');
        const chars = await new Promise((res, rej) => {
            const req = store.getAll(); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error);
        });
        for (const char of chars) currentState.characterCache.set(char.id, char);
    }
    
    function populateEditors() {
        $('#char-editor').html(`
            <input type="hidden" id="char-id">
            <div><label for="char-name" class="block text-sm font-medium">角色名称</label><input type="text" id="char-name" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></div>
            <div><label for="char-persona" class="block text-sm font-medium">角色设定</label><textarea id="char-persona" rows="8" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></textarea></div>
            <div><label for="char-greeting" class="block text-sm font-medium">开场白</label><textarea id="char-greeting" rows="4" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></textarea></div>
            <div class="flex space-x-2"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">保存角色</button><button type="button" id="delete-char-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden">删除角色</button></div>
        `).on('submit', saveCharacter);
        $('#delete-char-btn').on('click', deleteCharacter);

        $('#world-editor').html(`
            <input type="hidden" id="world-id">
            <div><label for="world-keywords" class="block text-sm font-medium">关键词</label><input type="text" id="world-keywords" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></div>
            <div><label for="world-content" class="block text-sm font-medium">内容</label><textarea id="world-content" rows="10" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></textarea></div>
            <div class="flex space-x-2"><button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">保存条目</button><button type="button" id="delete-world-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden">删除条目</button></div>
        `).on('submit', saveWorldbook);
        $('#delete-world-btn').on('click', deleteWorldbook);
        
        $('#group-editor').html(`
            <input type="hidden" id="group-id">
            <div><label for="group-name" class="block text-sm font-medium">群组名称</label><input type="text" id="group-name" class="w-full mt-1 p-2 bg-gray-700 rounded-lg" required></div>
            <div><label class="block text-sm font-medium">选择角色</label><div id="group-char-selection" class="mt-2 p-2 bg-gray-700 rounded-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
            <div class="flex space-x-2"><button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">保存群组</button><button type="button" id="delete-group-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden">删除群组</button></div>
        `).on('submit', saveGroup);
        $('#delete-group-btn').on('click', deleteGroup);
    }
    
    function renderListItem($listEl, item, type) {
        $('<li></li>')
            .addClass(`sidebar-item p-2 rounded-lg cursor-pointer flex justify-between items-center ${currentState.sessionId === `${type}_${item.id}` ? 'active' : ''}`)
            .text(item.name).attr({ 'data-id': item.id, 'data-type': type })
            .append($('<span></span>').text('✏️').addClass('text-sm opacity-50 hover:opacity-100').on('click', e => {
                e.stopPropagation();
                if (type === 'character') editCharacter(item.id);
                else if (type === 'group') editGroup(item.id);
            }))
            .on('click', () => selectSession(item.id, type))
            .appendTo($listEl);
    }
    
    // --- LOAD & RENDER FUNCTIONS ---
    async function loadAndRenderAll() {
        await cacheAllCharacters();
        loadCharacters();
        loadGroups();
        loadWorldbooks();
    }

    async function loadCharacters() {
        const $charList = $('#char-list').empty();
        const $groupCharSel = $('#group-char-selection').empty();
        const chars = Array.from(currentState.characterCache.values());
        
        if (chars.length === 0) {
            $groupCharSel.html('<p class="text-gray-400">请先创建角色</p>');
        } else {
            chars.forEach(char => {
                renderListItem($charList, char, 'character');
                $('<label></label>').addClass('flex items-center space-x-3')
                    .append($('<input>').attr({ type: 'checkbox', value: char.id }).addClass('form-checkbox h-5 w-5 bg-gray-800 text-purple-600 rounded'))
                    .append($('<span></span>').text(char.name))
                    .appendTo($groupCharSel);
            });
        }
    }

    async function loadGroups() {
        const $groupList = $('#group-list').empty();
        const groups = await new Promise(r => getStore('groups', 'readonly').getAll().onsuccess = e => r(e.target.result));
        groups.forEach(group => renderListItem($groupList, group, 'group'));
    }

    async function loadWorldbooks() {
        const $listEl = $('#world-list').empty();
        const entries = await new Promise(r => getStore('worldbooks', 'readonly').getAll().onsuccess = e => r(e.target.result));
        entries.forEach(entry => {
            $('<li></li>').addClass('sidebar-item p-2 rounded-lg cursor-pointer flex justify-between items-center')
                .text(`${entry.keywords.split(',')[0].trim()}...`).attr('title', entry.keywords)
                .append($('<span></span>').text('✏️').addClass('text-sm opacity-50 hover:opacity-100').on('click', e => { e.stopPropagation(); editWorldbook(entry.id); }))
                .appendTo($listEl);
        });
    }

    // --- CRUD OPERATIONS ---
    function setupDeleteConfirmation(btnId, originalText, deleteFn) {
        const $btn = $(`#${btnId}`);
        if ($btn.attr('data-confirming')) {
            deleteFn();
        } else {
            $btn.attr('data-confirming', 'true').text('确认删除？').removeClass('bg-red-600 hover:bg-red-700').addClass('bg-yellow-500 hover:bg-yellow-600');
            setTimeout(() => {
                if ($btn.attr('data-confirming')) {
                    $btn.removeAttr('data-confirming').text(originalText).removeClass('bg-yellow-500 hover:bg-yellow-600').addClass('bg-red-600 hover:bg-red-700');
                }
            }, 3000);
        }
    }
    
    function saveCharacter(e) { e.preventDefault(); 
        const id = $('#char-id').val();
        const name = $('#char-name').val().trim().replace(/\s+/g, '_');
        if (!name) return alert("角色名称不能为空。");
        const data = { name, persona: $('#char-persona').val(), greeting: $('#char-greeting').val() };
        const req = id ? getStore('characters', 'readwrite').put({ ...data, id: parseInt(id) }) : getStore('characters', 'readwrite').add(data);
        req.onsuccess = () => { showEditor(null); loadAndRenderAll(); };
    }
    function editCharacter(id) {
        const char = currentState.characterCache.get(id);
        if(!char) return;
        clearForms();
        $('#char-id').val(char.id); $('#char-name').val(char.name);
        $('#char-persona').val(char.persona); $('#char-greeting').val(char.greeting);
        $('#delete-char-btn').show(); showEditor('char');
    }
    function deleteCharacter() {
        setupDeleteConfirmation('delete-char-btn', '删除角色', async () => {
            const id = parseInt($('#char-id').val()); if (!id) return;
            await new Promise(r => getStore('characters', 'readwrite').delete(id).onsuccess = r);
            const groupStore = getStore('groups', 'readwrite');
            const groups = await new Promise(r => groupStore.getAll().onsuccess = e => r(e.target.result));
            for (const group of groups.filter(g => g.characterIds.includes(id))) {
                await new Promise(r => groupStore.delete(group.id).onsuccess = r);
                await deleteChatHistory(`group_${group.id}`);
            }
            await deleteChatHistory(`char_${id}`);
            await loadAndRenderAll(); showEditor(null);
            if (currentState.sessionId && currentState.sessionId.includes(`_${id}`)) showWelcomeScreen();
        });
    }
    
    function saveGroup(e) { e.preventDefault();
        const id = $('#group-id').val();
        const characterIds = $('#group-char-selection input:checked').map((_, el) => parseInt($(el).val())).get();
        if (characterIds.length < 1) return alert('群聊至少需要1个角色。');
        const data = { name: $('#group-name').val(), characterIds };
        const req = id ? getStore('groups', 'readwrite').put({ ...data, id: parseInt(id) }) : getStore('groups', 'readwrite').add(data);
        req.onsuccess = () => { showEditor(null); loadAndRenderAll(); };
    }
    function editGroup(id) {
        getStore('groups', 'readonly').get(id).onsuccess = e => {
            const group = e.target.result; clearForms();
            $('#group-id').val(group.id); $('#group-name').val(group.name);
            $('#group-char-selection input').each(function() {
                $(this).prop('checked', group.characterIds.includes(parseInt($(this).val())));
            });
            $('#delete-group-btn').show(); showEditor('group');
        };
    }
    function deleteGroup() {
        setupDeleteConfirmation('delete-group-btn', '删除群组', async () => {
            const id = parseInt($('#group-id').val()); if (!id) return;
            await new Promise(r => getStore('groups', 'readwrite').delete(id).onsuccess = r);
            await deleteChatHistory(`group_${id}`);
            await loadAndRenderAll(); showEditor(null);
            if (currentState.sessionId === `group_${id}`) showWelcomeScreen();
        });
    }

    function saveWorldbook(e) { e.preventDefault();
        const id = $('#world-id').val();
        const data = { keywords: $('#world-keywords').val(), content: $('#world-content').val() };
        const req = id ? getStore('worldbooks', 'readwrite').put({ ...data, id: parseInt(id) }) : getStore('worldbooks', 'readwrite').add(data);
        req.onsuccess = () => { showEditor(null); loadAndRenderAll(); };
    }
    function editWorldbook(id) {
        getStore('worldbooks', 'readonly').get(id).onsuccess = e => {
            const entry = e.target.result; clearForms();
            $('#world-id').val(entry.id); $('#world-keywords').val(entry.keywords);
            $('#world-content').val(entry.content);
            $('#delete-world-btn').show(); showEditor('world');
        };
    }
    function deleteWorldbook() {
        setupDeleteConfirmation('delete-world-btn', '删除条目', () => {
             const id = parseInt($('#world-id').val()); if(!id) return;
             getStore('worldbooks', 'readwrite').delete(id).onsuccess = () => {
                loadAndRenderAll(); showEditor(null);
            };
        });
    }

    // --- SESSION & CHAT LOGIC ---
    function showWelcomeScreen() {
        $('#chat-area').hide(); $('#chat-welcome').show();
        $('.sidebar-item').removeClass('active');
        currentState.sessionId = null; currentState.sessionType = null;
    }

    async function selectSession(id, type) {
        currentState.sessionId = `${type}_${id}`; currentState.sessionType = type;
        $('.sidebar-item').removeClass('active');
        $(`.sidebar-item[data-id='${id}'][data-type='${type}']`).addClass('active');
        $('#chat-welcome').hide(); $('#chat-area').show();
        
        let sessionName = '', participants = '', initialMessages = [];
        if (type === 'character') {
            const char = currentState.characterCache.get(id);
            sessionName = char.name; participants = `与 ${char.name} 对话中`;
            initialMessages.push({ role: 'char', content: char.greeting, characterId: id, characterName: char.name });
        } else {
            const group = await new Promise(r=>getStore('groups', 'readonly').get(id).onsuccess=e=>r(e.target.result));
            sessionName = group.name;
            const charNames = group.characterIds.map(cid => currentState.characterCache.get(cid)?.name || '未知');
            participants = `参与者: ${charNames.join(', ')}`;
            initialMessages.push({ role: 'system', content: `群聊 "${group.name}" 开始了。` });
        }
        
        $('#chat-session-name').text(sessionName); $('#chat-participants').text(participants);
        loadChatHistory(currentState.sessionId, initialMessages);
    }

    async function loadChatHistory(sessionId, initialMessages) {
        const $historyDiv = $('#chat-history').empty();
        const messages = await new Promise(r => getStore('chat_history', 'readonly').index('sessionId').getAll(sessionId).onsuccess = e => r(e.target.result));
        
        if (messages.length === 0 && initialMessages.length > 0) {
            for (const msg of initialMessages) {
                addMessageToChat(msg.role, msg.content, msg.characterName);
                if (msg.role !== 'system') saveMessage(sessionId, msg.role, msg.content, msg.characterId, msg.characterName);
            }
        } else messages.forEach(msg => addMessageToChat(msg.role, msg.content, msg.characterName));
    }

    function addMessageToChat(role, content, characterName = null) {
        const $historyContainer = $('#chat-history-container');
        const $bubble = $('<div></div>').addClass('p-3 rounded-lg chat-bubble').text(content);
        const $msgWrapper = $('<div></div>').addClass('flex flex-col').append($bubble);
        
        if (role === 'user') $msgWrapper.addClass('items-end').find('.chat-bubble').addClass('chat-bubble-user');
        else if (role === 'system') $msgWrapper.addClass('items-center').find('.chat-bubble').addClass('text-sm text-gray-400 italic text-center');
        else {
            $msgWrapper.addClass('items-start').find('.chat-bubble').addClass('chat-bubble-char');
            $msgWrapper.prepend($('<div></div>').addClass('speaker-name').text(characterName || '旁白'));
        }
        $('#chat-history').append($msgWrapper);
        $historyContainer.scrollTop($historyContainer[0].scrollHeight);
    }

    function saveMessage(sessionId, role, content, characterId = null, characterName = null) {
        getStore('chat_history', 'readwrite').add({ sessionId, role, content, characterId, characterName, timestamp: new Date() });
    }

    function deleteChatHistory(sessionId) {
        const index = getStore('chat_history', 'readwrite').index('sessionId');
        const request = index.openCursor(IDBKeyRange.only(sessionId));
        request.onsuccess = e => {
            const cursor = e.target.result; if (cursor) { cursor.delete(); cursor.continue(); }
        }; return request;
    }

    async function handleSendMessage() {
        const text = $('#user-input').val().trim();
        if (!text || !currentState.sessionId) return;
        addMessageToChat('user', text); saveMessage(currentState.sessionId, 'user', text);
        $('#user-input').val(''); addMessageToChat('char', '思考中...', 'AI');
        
        try {
            const participants = await getSessionParticipants();
            let mentionedChar = null;
            const match = text.match(/@([\p{L}\p{N}_]+)/u);
            if (match) mentionedChar = participants.find(p => p.name.toLowerCase() === match[1].toLowerCase());

            const prompt = await constructPrompt(mentionedChar ? mentionedChar.name : null);
            const responseText = await getAIResponse(prompt);
            $('#chat-history').children().last().remove();
            
            let characterName = null, content = responseText;
            const parts = responseText.split(':');
            const speakingChar = participants.find(p => p.name === parts[0].trim());
            if (speakingChar && parts.length > 1) {
                characterName = speakingChar.name;
                content = parts.slice(1).join(':').trim();
            }
            addMessageToChat('char', content, characterName);
            saveMessage(currentState.sessionId, 'char', content, speakingChar?.id, characterName);
        } catch (error) {
            console.error('Error:', error);
            $('#chat-history').children().last().remove();
            addMessageToChat('char', `抱歉，我出错了: ${error.message}`, '系统');
        }
    }

    async function getSessionParticipants() {
        if (!currentState.sessionId) return [];
        const [type, idStr] = currentState.sessionId.split('_');
        const id = parseInt(idStr);
        if (type === 'character') return [currentState.characterCache.get(id)].filter(Boolean);
        if (type === 'group') {
            const group = await new Promise(r=>getStore('groups', 'readonly').get(id).onsuccess=e=>r(e.target.result));
            return group ? group.characterIds.map(cid => currentState.characterCache.get(cid)).filter(Boolean) : [];
        } return [];
    }

    async function constructPrompt(targetCharacterName = null) {
        const participants = await getSessionParticipants();
        const history = (await new Promise(r => getStore('chat_history', 'readonly').index('sessionId').getAll(currentState.sessionId).onsuccess = e => r(e.target.result))).slice(-15);
        const convoText = history.map(h => h.content).join('\n');
        const worldbooks = await new Promise(r => getStore('worldbooks', 'readonly').getAll().onsuccess = e => r(e.target.result));
        const triggeredWorlds = worldbooks.filter(w => w.keywords.split(',').some(k => convoText.toLowerCase().includes(k.trim().toLowerCase())));

        let prompt = "[System Note: This is a roleplay conversation.]\n\n== CHARACTERS IN THIS SCENE ==\n";
        
        participants.forEach(p => { prompt += `Name: ${p.name}\nPersona: ${p.persona}\n\n`; });
        if (triggeredWorlds.length > 0) {
            prompt += "== RELEVANT WORLDBOOK ENTRIES ==\n";
            triggeredWorlds.forEach(w => prompt += `Content for "${w.keywords}": ${w.content}\n\n`);
        }
        prompt += "== RECENT CONVERSATION HISTORY ==\n";
        history.forEach(msg => { prompt += `${msg.role === 'user' ? 'User' : msg.characterName || 'Narration'}: ${msg.content}\n`; });
        
        let roleplayInstruction = '';
        const isGroup = currentState.sessionType === 'group' && participants.length > 1;
        if (isGroup) {
            if (targetCharacterName) {
                roleplayInstruction = `The User speaks directly to ${targetCharacterName}. ${targetCharacterName} MUST respond. Format: '${targetCharacterName}: Their dialogue'.`;
            } else {
                roleplayInstruction = `You are the roleplay master, responsible for driving the story forward. Based on the characters and world setting, you MUST decide who speaks next OR provide narration. Narration is crucial for describing the environment, introducing new events, or revealing challenges. For example, 'A cold wind blows through the trees, carrying the scent of decay.' Use narration to make the story dynamic and interesting. For character dialogue, use the format 'CharacterName: Their dialogue'. For narration, omit the prefix.`;
            }
        } else {
            roleplayInstruction = `Continue as ${participants[0].name}. Do not include your name as a prefix.`;
        }

        const langInstruction = currentLang === 'zh-CN' ? '你必须只使用简体中文进行回复。' : 'You MUST respond only in English.';
        prompt += `\n[System Note: ${roleplayInstruction} Final instruction: ${langInstruction}]`;
        
        return prompt;
    }
    
    async function getAIResponse(prompt) {
        console.log("--- PROMPT SENT TO AI ---\n", prompt);
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) {
            const errorBody = await response.json();
            throw new Error(`API Error: ${errorBody.error?.message || 'Unknown'}`);
        }
        const result = await response.json();
        if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text;
        throw new Error(result.promptFeedback?.blockReason ? `Content blocked: ${result.promptFeedback.blockReason}` : "AI failed to generate a valid response.");
    }
    
    // --- @MENTION SUGGESTIONS ---
    const $userInput = $('#user-input');
    const $suggestionsBox = $('#mention-suggestions');
    let mentionStartIndex = -1;

    async function handleMentionInput() {
        const textUpToCursor = $userInput.val().substring(0, $userInput[0].selectionStart);
        const mentionMatch = textUpToCursor.match(/@([\p{L}\p{N}_]*)$/u);
        if (mentionMatch) {
            const participants = await getSessionParticipants();
            if (participants.length > 1) {
                mentionStartIndex = mentionMatch.index;
                const partialName = mentionMatch[1].toLowerCase();
                const suggestions = participants.filter(p => p.name.toLowerCase().startsWith(partialName));
                renderMentionSuggestions(suggestions); return;
            }
        } hideMentionSuggestions();
    }

    function renderMentionSuggestions(suggestions) {
        if (suggestions.length === 0) return hideMentionSuggestions();
        $suggestionsBox.empty();
        suggestions.forEach(char => {
            $('<div></div>').text(char.name).addClass('p-2 px-3 cursor-pointer hover:bg-gray-600 rounded-md')
                .on('mousedown', e => { e.preventDefault(); selectMention(char.name); })
                .appendTo($suggestionsBox);
        });
        $suggestionsBox.show();
    }

    function hideMentionSuggestions() {
        if ($suggestionsBox.is(':visible')) $suggestionsBox.hide();
        mentionStartIndex = -1;
    }


    function selectMention(name) {
        const currentText = $userInput.val();
        const textBefore = currentText.substring(0, mentionStartIndex);
        const textAfter = currentText.substring($userInput[0].selectionStart);
        $userInput.val(`${textBefore}@${name} ${textAfter}`);
        hideMentionSuggestions(); $userInput.focus();
        const newCursorPos = (textBefore + `@${name} `).length;
        $userInput[0].setSelectionRange(newCursorPos, newCursorPos);
    }
    
    // --- APP INITIALIZATION ---
    function initializeAppLogic() {
        populateEditors();
        loadAndRenderAll();
        $('#new-char-btn').on('click', () => showEditor('char'));
        $('#new-group-btn').on('click', () => showEditor('group'));
        $('#new-world-btn').on('click', () => showEditor('world'));
        $('#send-btn').on('click', () => { handleSendMessage(); hideMentionSuggestions(); });
        $userInput.on('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); hideMentionSuggestions(); }
            if (e.key === 'Escape') hideMentionSuggestions();
        });
        $userInput.on('input click', handleMentionInput);
        $userInput.on('blur', () => setTimeout(hideMentionSuggestions, 150));
    }

    // --- START THE APP ---
    setLanguage(getLanguage());
    showWorldSelectionDialog();

    });
    </script>
</body>
</html>